ext {
    getVersionCode = this.&getVersionCode
    alreadyGenerated = false
}

def getVersionCode() {
    def versionFile = file('version.properties')
    if (versionFile.canRead()) {
        def versionProps = new Properties()
        versionProps.load(new FileInputStream(versionFile))
        def versionCode = versionProps.getProperty("VERSION_CODE")
        def runTasks = gradle.startParameter.taskNames
        if ('bintrayUpload' in runTasks && !alreadyGenerated) {
            def versionArgs = versionCode.split("\\.")
            if (versionArgs[versionArgs.length - 1] == "#") {
                versionArgs[versionArgs.length - 1] = 0
            } else {
                versionArgs[versionArgs.length - 1] = ++versionArgs[versionArgs.length - 1] as Integer
            }
            versionProps['VERSION_CODE'] = versionArgs.join(".")
            versionProps.store(versionFile.newWriter(), null)
            alreadyGenerated = true
        }
        return versionCode
    } else {
        throw new GradleException("Could not find version.properties!")
    }
}